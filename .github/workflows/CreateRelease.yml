name: "Create Incremental Release Tag And Deploy To Production"

on: 
  push:
    branches:
      - main
  workflow_dispatch:

jobs:

  release-and-check-can-deploy:
    name: Create Incremental Release Tag And Check Can Deploy
    runs-on: ubuntu-latest
    outputs:
      can-deploy: ${{ steps.final.outputs.can-deploy }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - id: latest
        name: Get Current Latest Release Version
        uses: thebritican/fetch-latest-release@v1.0.3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - run: echo "${{ steps.latest.outputs.tag_name }}"
      - id: release
        name: Create Incremental Release Tag
        uses: rymndhng/release-on-push-action@master
        with:
          bump_version_scheme: norelease
      - id: final
        run: | 
          echo "${{ steps.release.outputs.tag_name }}"
          if [ "${{ steps.release.outputs.tag_name }}" == '' ]; then
            echo "can-deploy=false" >> $GITHUB_OUTPUT;
          else
            echo "can-deploy=${{ steps.release.outputs.tag_name != steps.latest.outputs.tag_name }}" >> $GITHUB_OUTPUT;
          fi
